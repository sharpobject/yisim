#!/usr/bin/env python3
"""
Generate a CSV of game cards for use in card implementation.

Usage:
    python generate_card_csv.py [version_dir]

Example:
    python generate_card_csv.py 1.5.9

This script reads combined_cards.json and card_classification.json from the
specified version directory and generates a CSV file with card data.
"""

import json
import csv
import sys
from pathlib import Path

# Categories to exclude from the CSV (these are not real battle cards)
EXCLUDED_CATEGORIES = {
    'unused',
    'unused_empty',
    'artillery_minigame',
    'bridge_minigame',
    'shopkeeper',
    'voucher',
    'non_playable_special',  # items that go straight to inventory
}

# Additional base_ids to exclude (non-playable cards marked in classification)
# These are cards that exist but can't be put in decks or played
def get_excluded_base_ids(classification):
    """Get set of base_ids to exclude based on classification."""
    excluded = set()

    # Add all cards from excluded categories
    for cat_name, cat_data in classification.get('categories', {}).items():
        if cat_name in EXCLUDED_CATEGORIES:
            for card in cat_data.get('cards', []):
                excluded.add(card['base_id'])

    # Add cards from the top-level unused list
    for base_id in classification.get('unused', []):
        excluded.add(base_id)

    return excluded

def get_category_for_card(base_id, classification):
    """Find which category a card belongs to."""
    for cat_name, cat_data in classification.get('categories', {}).items():
        for card in cat_data.get('cards', []):
            if card['base_id'] == base_id:
                return cat_name
    return 'unknown'

# CSV base_id -> swogi base_id mapping (generated by matching card names)
# To get full swogi_card_id, append level digit (1-3)
CSV_TO_SWOGI_BASE = {
    '2': '61501', '3': '61401', '5': '62402', '6': '62303', '7': '62403',
    '8': '61201', '9': '61403', '10': '62302', '11': '62401', '12': '62201',
    '13': '63302', '15': '61402', '16': '61502', '17': '63403', '18': '63401',
    '19': '61103', '20': '63201', '21': '63501', '22': '62101', '23': '62501',
    '28': '62301', '29': '62502', '32': '63402', '36': '61101', '37': '61102',
    '38': '63301', '39': '60301', '40': '60601', '41': '60201', '45': '64201',
    '47': '71402', '48': '71401', '49': '71502', '50': '71501', '51': '72401',
    '52': '72402', '53': '72501', '54': '72502', '55': '73401', '56': '73402',
    '57': '73501', '58': '73502', '60': '60506', '61': '60507', '62': '60503',
    '63': '60504', '64': '60508', '65': '60502', '66': '60505', '67': '60501',
    '68': '60509', '69': '60510', '70': '64202', '73': '64301', '74': '64401',
    '75': '64501', '76': '60302', '77': '60602', '78': '60102', '79': '60603',
    '80': '60303', '81': '64402', '82': '64502', '83': '80104', '84': '80105',
    '85': '80102', '86': '80204', '87': '80201', '88': '80206', '89': '80301',
    '90': '80302', '91': '80303', '92': '80401', '93': '80402', '94': '80403',
    '95': '80501', '96': '80502', '97': '80503', '98': '80103', '99': '80101',
    '100': '80106', '101': '80203', '102': '80202', '103': '80205', '104': '80304',
    '105': '80305', '106': '80306', '107': '80404', '108': '80405', '109': '80406',
    '110': '80504', '111': '80505', '112': '80506', '113': '80107', '213': '61503',
    '218': '63502', '219': '64101', '220': '64503', '221': '64203', '222': '64403',
    '258': '73301', '260': '71403', '261': '71404', '262': '71405', '263': '71406',
    '264': '71503', '265': '72403', '266': '72404', '268': '72406', '269': '72503',
    '270': '73403', '271': '73503', '272': '73404', '273': '73405', '274': '73505',
    '275': '74401', '277': '74402', '278': '74403', '280': '70101', '281': '70102',
    '282': '70105', '283': '70106', '284': '70104', '285': '70103', '286': '60101',
    '288': '71504', '291': '74404', '292': '73506', '294': '72505', '295': '73504',
    '296': '74501', '297': '74502', '298': '72504', '301': '80507', '302': '80508',
    '303': '80407', '306': '80408', '307': '72405', '308': '74503', '309': '71506',
    '312': '71507', '323': '71407', '325': '71505',
    # Sect 1 - Cloud Sword
    '1000001': '11101', '1000002': '11102', '1000003': '11103', '1000004': '11104',
    '1000005': '11105', '1000006': '11106', '1000007': '11107', '1000008': '11309',
    '1000009': '11108', '1000010': '11109', '1000011': '11210', '1000012': '11110',
    '1000013': '11112', '1000014': '11203', '1000015': '11202', '1000016': '11201',
    '1000017': '11207', '1000018': '11204', '1000019': '11206', '1000020': '11306',
    '1000021': '11111', '1000022': '11211', '1000023': '11307', '1000024': '11205',
    '1000025': '11506', '1000026': '11301', '1000027': '11303', '1000028': '11302',
    '1000029': '11308', '1000030': '11209', '1000031': '11305', '1000032': '11311',
    '1000033': '11208', '1000034': '11403', '1000035': '11410', '1000036': '11406',
    '1000037': '11408', '1000038': '11407', '1000039': '11401', '1000040': '11402',
    '1000041': '11409', '1000042': '11501', '1000043': '11503', '1000044': '11505',
    '1000045': '11504', '1000046': '11310', '1000047': '21101', '1000048': '21201',
    '1000049': '21301', '1000050': '21401', '1000051': '21402', '1000052': '21601',
    '1000053': '21501', '1000054': '21102', '1000055': '21202', '1000056': '21302',
    '1000057': '21502', '1000058': '21602', '1000059': '11405', '1000060': '11502',
    '1000061': '21503', '1000062': '21303', '1000063': '11304', '1000064': '11507',
    '1000065': '11404', '1000066': '11508',
    # Side job - Elixirist
    '2000001': '31103', '2000002': '31102', '2000003': '31101', '2000004': '31202',
    '2000005': '31201', '2000007': '31301', '2000008': '31302', '2000010': '31402',
    '2000011': '31401', '2000013': '31501',
    # Side job - Talisman/Fuluist
    '3000001': '32101', '3000002': '32102', '3000003': '32103', '3000004': '32203',
    '3000005': '32201', '3000006': '32202', '3000007': '32302', '3000008': '32303',
    '3000009': '32301', '3000010': '32401', '3000011': '32402', '3000012': '32403',
    '3000013': '32502', '3000014': '32501', '3000015': '32503',
    # Sect 2 - Heptastar
    '4000001': '12107', '4000002': '12106', '4000003': '12105', '4000004': '12108',
    '4000005': '12109', '4000006': '12111', '4000008': '12102', '4000009': '12203',
    '4000010': '12104', '4000011': '12103', '4000013': '12112', '4000014': '12403',
    '4000015': '12205', '4000016': '12204', '4000017': '12308', '4000018': '12211',
    '4000019': '12207', '4000020': '12208', '4000021': '12210', '4000022': '12307',
    '4000023': '12101', '4000024': '12201', '4000025': '12303', '4000026': '12503',
    '4000027': '12209', '4000028': '12202', '4000029': '12302', '4000030': '12206',
    '4000031': '12304', '4000032': '12301', '4000033': '12311', '4000034': '12404',
    '4000035': '12406', '4000036': '12409', '4000037': '12408', '4000038': '12401',
    '4000039': '12402', '4000040': '12306', '4000041': '12505', '4000042': '12309',
    '4000043': '12310', '4000044': '12502', '4000045': '12501', '4000046': '12504',
    '4000047': '22101', '4000048': '22201', '4000049': '22502', '4000050': '22301',
    '4000051': '22402', '4000052': '22602', '4000053': '22102', '4000054': '22202',
    '4000055': '22302', '4000056': '22401', '4000057': '22501', '4000058': '22601',
    '4000059': '12410', '4000060': '12506', '4000061': '12110', '4000062': '12405',
    '4000063': '12407', '4000064': '22403', '4000065': '22503', '4000066': '12507',
    '4000067': '12508', '4000068': '12305',
    # Side job - Musician
    '5000001': '33101', '5000002': '33102', '5000003': '33103', '5000004': '33203',
    '5000005': '33202', '5000006': '33201', '5000007': '33301', '5000008': '33302',
    '5000009': '33303', '5000010': '33401', '5000011': '33402', '5000012': '33403',
    '5000013': '33502', '5000014': '33503', '5000015': '33501',
    # Side job - Painter
    '6000001': '34101', '6000003': '34102', '6000004': '34201', '6000005': '34202',
    '6000006': '34203', '6000007': '34301', '6000008': '34302', '6000011': '34401',
    '6000012': '34501', '6000013': '34502', '6000014': '34402',
    # Sect 3 - Five Elements
    '7000001': '13107', '7000002': '13108', '7000003': '13101', '7000004': '13102',
    '7000006': '13109', '7000007': '13110', '7000009': '13103', '7000010': '13104',
    '7000011': '13105', '7000012': '13305', '7000013': '13106', '7000014': '13211',
    '7000015': '13208', '7000016': '13207', '7000017': '13202', '7000018': '13201',
    '7000019': '13209', '7000020': '13410', '7000021': '13203', '7000022': '13204',
    '7000023': '13205', '7000024': '13206', '7000025': '13307', '7000026': '13308',
    '7000027': '13402', '7000028': '13302', '7000029': '13309', '7000030': '13409',
    '7000031': '13303', '7000032': '13304', '7000033': '13406', '7000034': '13407',
    '7000035': '13408', '7000036': '13301', '7000037': '13210', '7000038': '13403',
    '7000039': '13404', '7000040': '13405', '7000042': '13504', '7000043': '13501',
    '7000044': '23502', '7000045': '23501', '7000046': '23401', '7000047': '23403',
    '7000048': '23202', '7000049': '23203', '7000050': '23302', '7000051': '23402',
    '7000052': '23601', '7000053': '13503', '7000055': '23303', '7000056': '13502',
    '7000057': '13505', '7000058': '13506', '7000059': '13310', '7000060': '13111',
    '7000061': '13401', '7000062': '13306', '7000063': '23201', '7000064': '23301',
    '7000065': '23602', '7000066': '13411', '7000067': '13311', '7000068': '23101',
    '7000069': '23102', '7000070': '23103', '7000071': '23104', '7000072': '23105',
    '7000073': '13507',
    # Side job - Formation
    '8000001': '35101', '8000002': '35102', '8000003': '35103', '8000004': '35201',
    '8000005': '35202', '8000006': '35203', '8000007': '35301', '8000008': '35302',
    '8000009': '35303', '8000010': '35402', '8000011': '35401', '8000012': '35502',
    '8000013': '35501', '8000014': '35503', '8000016': '35403',
    # Side job - Plant Master
    '9000003': '36101', '9000005': '36301', '9000006': '36202', '9000009': '36203',
    '9000011': '36503', '9000013': '36401', '9000015': '36502', '9000017': '36302',
    '9000018': '36204', '9000019': '36504', '9000020': '36403', '9000026': '36402',
    '9000027': '36102',
    # Sect 4 - Forge Body Soul
    '10000001': '14101', '10000002': '14102', '10000003': '14103', '10000004': '14104',
    '10000005': '14105', '10000006': '14106', '10000007': '14108', '10000008': '14107',
    '10000009': '14109', '10000010': '14110', '10000011': '14111', '10000012': '14112',
    '10000013': '14201', '10000014': '14202', '10000015': '14203', '10000016': '14204',
    '10000017': '14205', '10000018': '14206', '10000019': '14207', '10000020': '14309',
    '10000021': '14208', '10000022': '14209', '10000023': '14211', '10000024': '14302',
    '10000025': '14402', '10000026': '14301', '10000027': '14304', '10000028': '14306',
    '10000029': '14307', '10000030': '14308', '10000031': '14305', '10000032': '14210',
    '10000033': '14311', '10000034': '14310', '10000035': '14403', '10000036': '14303',
    '10000037': '14404', '10000038': '14405', '10000039': '14407', '10000040': '14408',
    '10000041': '14505', '10000042': '14409', '10000043': '14410', '10000044': '14401',
    '10000045': '14501', '10000046': '14502', '10000047': '14504', '10000048': '14503',
    '10000050': '14406', '10000051': '14507', '10000052': '14508', '10000053': '24102',
    '10000054': '24101', '10000055': '24201', '10000056': '24202', '10000057': '24401',
    '10000060': '24402', '10000061': '24302', '10000062': '24501', '10000064': '24502',
    '10000065': '24601', '10000066': '24602', '10000067': '24403', '10000068': '14506',
    # Side job - Fortune Teller
    '11000001': '37103', '11000003': '37102', '11000004': '37101', '11000005': '37304',
    '11000007': '37202', '11000008': '37201', '11000009': '37203', '11000011': '37301',
    '11000012': '37302', '11000013': '37401', '11000014': '37404', '11000018': '37501',
    '11000019': '37503', '11000020': '37504', '11000021': '37502', '11000022': '37104',
    '11000023': '37204', '11000024': '37303', '11000025': '37403', '11000026': '37402',
    # Talisman items
    '99000100': '40101', '99000101': '40201', '99000102': '40301', '99000103': '40401',
    '99000104': '40501', '99000105': '40601', '99000106': '40502', '99000107': '40102',
    '99000108': '40202', '99000109': '40302', '99000110': '40402', '99000111': '40602',
    '99000112': '40303', '99000113': '40403', '99000114': '40503',
    # Spiritual pets
    '99000200': '50101', '99000201': '50201', '99000202': '50301', '99000203': '50302',
    '99000204': '50501', '99000205': '50401', '99000206': '50601', '99000207': '50402',
    '99000208': '50102', '99000209': '50202', '99000210': '50502', '99000211': '50602',
    '99000212': '50403',
    # Fusion cards (immortal_relics_fusion)
    '122': '91501', '123': '91502', '124': '91503', '125': '91401', '126': '91504',
    '127': '92301', '128': '92501', '129': '92401', '130': '92402', '131': '92502',
    '132': '93501', '133': '93502', '134': '93503', '135': '93301', '136': '93401',
    '137': '94501', '138': '94502', '139': '94401', '140': '94402', '141': '91505',
    '142': '92201', '143': '93402', '144': '94403', '151': '91301', '152': '92503',
    '153': '93201', '154': '94301', '156': '90401', '157': '90501', '158': '90402',
    '159': '90403', '160': '90404', '161': '90405', '162': '90301', '163': '91506',
    '164': '92504', '165': '93504', '166': '94503', '167': '91507', '168': '92505',
    '169': '93505', '170': '94504', '171': '91601', '172': '92601', '173': '93601',
    '174': '94601', '175': '90601', '176': '90602', '177': '90603', '178': '90604',
    '179': '90605', '180': '90606', '181': '90607', '183': '91402', '184': '91403',
    '185': '91302', '186': '91508', '187': '91404', '188': '91405', '189': '91509',
    '190': '92506', '191': '92507', '192': '92403', '193': '92404', '194': '92405',
    '195': '92508', '196': '92509', '197': '93506', '198': '93302', '199': '93507',
    '200': '93508', '201': '93403', '202': '93509', '203': '93404', '204': '94404',
    '205': '94405', '206': '94406', '207': '94505', '208': '94506', '209': '94407',
    '210': '94507',
    # Seasonal special
    '182': '90600',  # Crimson Star
}

def game_id_to_swogi_id(card):
    """
    Map a game card to its swogi card_id using the CSV_TO_SWOGI_BASE mapping.
    Returns the full swogi_card_id (base + level) or None if not found.
    """
    base_id = str(card.get('base_id', ''))
    level = card.get('level', 1)

    if base_id in CSV_TO_SWOGI_BASE:
        swogi_base = CSV_TO_SWOGI_BASE[base_id]
        return f"{swogi_base}{level}"
    return None

def generate_csv(version_dir):
    """Generate the card CSV file."""
    version_path = Path(version_dir)

    # Load data files
    combined_cards_path = version_path / 'combined_cards.json'
    classification_path = version_path / 'card_classification.json'

    if not combined_cards_path.exists():
        print(f"Error: {combined_cards_path} not found")
        sys.exit(1)

    with open(combined_cards_path, 'r', encoding='utf-8') as f:
        combined_cards = json.load(f)

    # Load classification if available
    classification = {}
    if classification_path.exists():
        with open(classification_path, 'r', encoding='utf-8') as f:
            classification = json.load(f)

    # Get excluded base_ids
    excluded_base_ids = get_excluded_base_ids(classification)

    # Prepare CSV data
    csv_rows = []

    for card in combined_cards:
        base_id = card.get('base_id')

        # Skip excluded cards
        if base_id in excluded_base_ids:
            continue

        # Get category
        category = get_category_for_card(base_id, classification)

        # Skip cards from excluded categories
        if category in EXCLUDED_CATEGORIES:
            continue

        game_card_id = card.get('card_id')
        level = card.get('level', 1)
        phase = card.get('phase', 0)

        # Get costs
        qi_cost = card.get('qi_cost', 0)
        hp_cost = card.get('hp_cost', 0)

        # Get text
        text_zh = card.get('desc_cn', '').replace('\\n', '\n')
        text_en = card.get('desc_en', '').replace('\\n', '\n')
        name_en = card.get('name_en', '')
        name_zh = card.get('name_cn', '')

        # Try to get swogi_id (placeholder - needs manual mapping)
        swogi_id = game_id_to_swogi_id(card)

        csv_rows.append({
            'game_card_id': game_card_id,
            'base_id': base_id,
            'swogi_card_id': swogi_id or '',
            'name_en': name_en,
            'name_zh': name_zh,
            'hp_cost': hp_cost,
            'qi_cost': qi_cost,
            'category': category,
            'phase': phase,
            'level': level,
            'text_zh': text_zh,
            'text_en': text_en,
        })

    # Sort by category, then base_id, then level
    csv_rows.sort(key=lambda x: (x['category'], x['base_id'], x['level']))

    # Write CSV
    output_path = version_path / 'card_data.csv'
    fieldnames = ['game_card_id', 'base_id', 'swogi_card_id', 'name_en', 'name_zh',
                  'hp_cost', 'qi_cost', 'category', 'phase', 'level', 'text_zh', 'text_en']

    with open(output_path, 'w', newline='', encoding='utf-8') as f:
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(csv_rows)

    print(f"Generated {output_path} with {len(csv_rows)} cards")

    # Print category counts
    category_counts = {}
    for row in csv_rows:
        cat = row['category']
        category_counts[cat] = category_counts.get(cat, 0) + 1

    print("\nCards by category:")
    for cat, count in sorted(category_counts.items()):
        print(f"  {cat}: {count}")

def main():
    version_dir = sys.argv[1] if len(sys.argv) > 1 else '1.5.9'
    generate_csv(version_dir)

if __name__ == '__main__':
    main()
